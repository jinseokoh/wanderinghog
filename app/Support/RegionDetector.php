<?php

namespace App\Support;

use Spatie\Geocoder\Facades\Geocoder;

class RegionDetector
{
    private $parser;
    private $calculator;

    public function __construct()
    {
        $this->parser = new RegionParser();
        $this->calculator = new RegionCalculator();
    }

    private function getAlternativeAddressFromReverseGeocode($address, $latitude, $longitude)
    {
        $addresses = Geocoder::getAllAddressesForCoordinates($latitude, $longitude);;

        return collect($addresses)
            ->map(function ($item) use ($address) {
                return $item['formatted_address'];
            })
            ->filter(function ($item) use ($address) {
                return $item !== $address;
            })
            ->first(function ($item) {
                return !! $this->parser->seoul($item);
            });
    }

    public function detect(
        string $address,
        float $latitude = 0,
        float $longitude = 0
    ) {
        $result = $this->parser->area($address);

        if ($result === 'seoul') {
            $district = $this->parser->seoul($address);
            if (! $district) {
                $alternative = $this->getAlternativeAddressFromReverseGeocode($address, $latitude, $longitude);
                $district = $this->parser->seoul($alternative);
            }
            $geoJsonData = $this->geoJson($district);
            foreach ($geoJsonData as $key => $value) {
                if ($this->calculator->include($latitude, $longitude, $value)) {
                    return $key;
                }
            }
            return "{$district}_etc";
        }

        if ($result == 'gyeonggi') {
            return $this->parser->gyeonggi($address);
        }

        return $result;
    }

    private function geoJson(string $key): array
    {
        $data = [
            'seoul_gangbuk' => [
                'jongno' => [
                    [37.57010998154294, 126.9828987121582],
                    [37.568749367590925, 126.98261976242065],
                    [37.56796700331381, 126.9875121116638],
                    [37.56851125759388, 126.99553728103638],
                    [37.56946369301487, 127.001953125],
                    [37.57096035264116, 127.00193166732787],
                    [37.57048414602233, 126.99257612228392],
                    [37.57441275956808, 126.99098825454712],
                    [37.57420868085078, 126.98909997940063],
                    [37.57354542115709, 126.98755502700807],
                    [37.57024604157113, 126.98755502700807],
                    [37.57010998154294, 126.9828987121582],
                ],
                'euljiro' => [
                    [37.56865582446858, 126.98264122009279],
                    [37.56589199738889, 126.98255538940428],
                    [37.566070586237714, 126.98756575584412],
                    [37.56444626237447, 126.98770523071288],
                    [37.564735411621996, 126.98994755744934],
                    [37.56433570501264, 126.99294090270995],
                    [37.56422514748672, 126.99609518051149],
                    [37.564667376605904, 127.00244665145873],
                    [37.569412669997504, 127.00201749801637],
                    [37.568485745763354, 126.99565529823303],
                    [37.567992515322025, 126.98962569236755],
                    [37.56792448328069, 126.98747992515564],
                    [37.56865582446858, 126.98264122009279],
                ],
                'gwanghwamun' => [
                    [37.57558620133929, 126.97682619094847],
                    [37.57587530734239, 126.97431564331055],
                    [37.57927647015724, 126.97384357452391],
                    [37.57946352960474, 126.97133302688599],
                    [37.575892313542916, 126.97264194488524],
                    [37.56939566231726, 126.97251319885252],
                    [37.56914054664785, 126.97603225708009],
                    [37.56895346126822, 126.97708368301392],
                    [37.56876637541872, 126.98255538940428],
                    [37.57187874252181, 126.98298454284668],
                    [37.57541613846023, 126.9828987121582],
                    [37.57954855647096, 126.98214769363402],
                    [37.58010973135285, 126.9798731803894],
                    [37.579123421168816, 126.97948694229125],
                    [37.57652154023188, 126.97946548461914],
                    [37.57587530734239, 126.97884321212767],
                    [37.57558620133929, 126.97682619094847],
                ],
                'itaewon' => [
                    [37.53938806920895, 126.99536561965941],
                    [37.536954951447285, 126.99435710906981],
                    [37.53465787930752, 126.98669672012328],
                    [37.532956298771296, 126.98922872543335],
                    [37.52985932256797, 126.99129939079283],
                    [37.531824726221714, 126.99217915534972],
                    [37.531441859441856, 126.99504375457762],
                    [37.530318772216255, 126.9968032836914],
                    [37.53078672728208, 127.00225353240965],
                    [37.53253089757109, 127.00356245040894],
                    [37.53438562903068, 127.00377702713011],
                    [37.53593403923169, 127.00124502182005],
                    [37.537601521954684, 127.00225353240965],
                    [37.537380327412, 127.00474262237547],
                    [37.54081727619278, 127.00375556945801],
                    [37.54296103530175, 127.00103044509888],
                    [37.54085130459659, 126.99828386306763],
                    [37.54100443222156, 126.99714660644531],
                    [37.53938806920895, 126.99536561965941],
                ],
                'sinchon_hongdae' => [
                    [37.55655375544381, 126.94285869598389],
                    [37.56012589878599, 126.94277286529541],
                    [37.560330016090184, 126.94024085998535],
                    [37.56026197705092, 126.93629264831543],
                    [37.560806287625354, 126.93333148956299],
                    [37.562609288000566, 126.9312286376953],
                    [37.55267523449288, 126.91801071166991],
                    [37.551586490574266, 126.91938400268553],
                    [37.54825211338595, 126.91590785980225],
                    [37.54787783724749, 126.91835403442383],
                    [37.54770771110877, 126.9276237487793],
                    [37.55345775936034, 126.9340181350708],
                    [37.555158872030226, 126.9370651245117],
                    [37.55655375544381, 126.94285869598389],
                ],
                'yeonnam' => [
                    [37.56461635030305, 126.92916870117186],
                    [37.56689549107832, 126.9308853149414],
                    [37.56876637541872, 126.9281816482544],
                    [37.56631720822982, 126.9260358810425],
                    [37.56788196322332, 126.91736698150633],
                    [37.564072067564595, 126.9178605079651],
                    [37.561656764937155, 126.91865444183348],
                    [37.56026197705092, 126.91627264022826],
                    [37.55598389769161, 126.92052125930786],
                    [37.55638364910836, 126.92148685455322],
                    [37.55699603009862, 126.92180871963501],
                    [37.557965623040786, 126.92307472229004],
                    [37.55742129171425, 126.92350387573242],
                    [37.558033664177, 126.92429780960082],
                    [37.56461635030305, 126.92916870117186],
                ],
                'hapjeong_mangwon' => [
                    [37.55156947882434, 126.9192123413086],
                    [37.552624199977, 126.91781759262086],
                    [37.556962009064506, 126.91404104232788],
                    [37.55595838157092, 126.91118717193604],
                    [37.558271807664525, 126.90884828567505],
                    [37.55573724149231, 126.89704656600952],
                    [37.547163304855566, 126.90882682800292],
                    [37.54835418837027, 126.91065073013306],
                    [37.54728239406319, 126.91153049468993],
                    [37.546210584345204, 126.91603660583495],
                    [37.5479288750134, 126.91704511642455],
                    [37.54830315089558, 126.9157576560974],
                    [37.55156947882434, 126.9192123413086],
                ],
                'sangam' => [
                    [37.55893520336642, 126.89260482788086],
                    [37.563697870875174, 126.90316200256348],
                    [37.56441224474215, 126.90595149993896],
                    [37.56669139176207, 126.90359115600585],
                    [37.57209983469063, 126.9085693359375],
                    [37.57982064179042, 126.89955711364745],
                    [37.58247342154689, 126.89513683319093],
                    [37.584786024212136, 126.88981533050536],
                    [37.5870985550357, 126.8869400024414],
                    [37.57999069461015, 126.87612533569336],
                    [37.57788201219356, 126.86870098114012],
                    [37.57529709421376, 126.86526775360107],
                    [37.55893520336642, 126.89260482788086],
                ],
                'dongdaemun' => [
                    [37.56368086189009, 127.00456023216248],
                    [37.56485447275064, 127.01133012771606],
                    [37.56539874977264, 127.01615810394289],
                    [37.57306923106738, 127.01572895050049],
                    [37.57121546207729, 127.00862646102905],
                    [37.5711814475363, 127.00534343719482],
                    [37.56932763155751, 127.00585842132568],
                    [37.56658083773227, 127.00437784194946],
                    [37.56368086189009, 127.00456023216248],
                ],
                'geondae' => [
                    [37.537346297424094, 127.06124067306519],
                    [37.53297331476884, 127.07626104354857],
                    [37.53755047711846, 127.07870721817015],
                    [37.53998357544818, 127.08254814147948],
                    [37.541412771017235, 127.08312749862671],
                    [37.54209333070699, 127.08151817321777],
                    [37.54330130885675, 127.08160400390625],
                    [37.543352349756034, 127.07973718643188],
                    [37.545036679829, 127.08018779754639],
                    [37.544951613566035, 127.07284927368164],
                    [37.54687408741636, 127.0665407180786],
                    [37.537346297424094, 127.06124067306519],
                ],
                'wangsimni' => [
                    [37.55771046822659, 127.04077005386351],
                    [37.562320130500794, 127.04173564910887],
                    [37.565449775539584, 127.04173564910887],
                    [37.566079090457926, 127.03652143478394],
                    [37.561095451000654, 127.03527688980103],
                    [37.55888417313751, 127.03725099563599],
                    [37.55771046822659, 127.04077005386351],
                ],
                'seoungsu' => [
                    [37.54292700786083, 127.03068494796753],
                    [37.53818002765651, 127.04240083694458],
                    [37.53511729939603, 127.05415964126587],
                    [37.54085130459659, 127.05761432647706],
                    [37.54724836859472, 127.06079006195067],
                    [37.548286138396264, 127.05999612808228],
                    [37.54867742489846, 127.05851554870605],
                    [37.55073589832137, 127.05276489257811],
                    [37.551637525800764, 127.04731464385986],
                    [37.551246254838, 127.04158544540405],
                    [37.54896663534077, 127.03778743743895],
                    [37.54711226656548, 127.03630685806274],
                    [37.54292700786083, 127.03068494796753],
                ],
            ],

            'seoul_gangnam' => [
                'gangnam_station' => [
                    [37.50390433194256, 127.02283143997191],
                    [37.49091493882098, 127.02898979187012],
                    [37.49265152849667, 127.03409671783447],
                    [37.5056235973398, 127.02813148498535],
                    [37.50390433194256, 127.02283143997191],
                ],
                'apgujeong_sinsa' => [
                    [37.51610855686204, 127.0195698738098],
                    [37.519801771325895, 127.02808856964111],
                    [37.52322251197417, 127.03913927078247],
                    [37.527817289890535, 127.0407485961914],
                    [37.529127600618814, 127.03574895858765],
                    [37.52926373547845, 127.03373193740845],
                    [37.52866814363325, 127.03117847442626],
                    [37.52192911603872, 127.01770305633545],
                    [37.51610855686204, 127.0195698738098],
                ],
                'cheongdam' => [
                    [37.51718079924645, 127.04137086868288],
                    [37.52014215055589, 127.05742120742798],
                    [37.525264670430836, 127.05458879470827],
                    [37.52451588548744, 127.04864501953125],
                    [37.527102565246366, 127.04720735549925],
                    [37.528514990675795, 127.04096317291258],
                    [37.52308636608947, 127.03926801681517],
                    [37.51718079924645, 127.04137086868288],
                ],
                'seocho' => [
                    [37.491425704681575, 127.01551437377931],
                    [37.4931282323249, 127.01523542404175],
                    [37.493741132776165, 127.01718807220459],
                    [37.49517121426944, 127.0164370536804],
                    [37.492532352064195, 127.00716733932494],
                    [37.48682868620028, 127.00989246368408],
                    [37.488429161772785, 127.01476335525513],
                    [37.49128950079359, 127.01414108276366],
                    [37.491425704681575, 127.01551437377931],
                ],
                'yeoksam' => [
                    [37.50049972918221, 127.05090880393983],
                    [37.50312128705489, 127.05880522727968],
                    [37.50703642936521, 127.05657362937927],
                    [37.50524910725981, 127.05082297325137],
                    [37.50632150565806, 127.05028653144836],
                    [37.50427882876828, 127.0436990261078],
                    [37.503274492135674, 127.04425692558291],
                    [37.50148707996544, 127.03835606575014],
                    [37.50391284325492, 127.0371437072754],
                    [37.503095752844196, 127.03447222709657],
                    [37.499299569701854, 127.03612446784972],
                    [37.500193307318945, 127.03903198242186],
                    [37.50111256913632, 127.03850626945497],
                    [37.50419371601827, 127.04897761344911],
                    [37.50049972918221, 127.05090880393983],
                ],
                'jamsil' => [
                    [37.51188751651357, 127.07825660705566],
                    [37.50695131975909, 127.07958698272705],
                    [37.50807475874651, 127.08641052246092],
                    [37.511359869684064, 127.08555221557617],
                    [37.511785391611866, 127.09248304367065],
                    [37.51025350131836, 127.09314823150635],
                    [37.509896055725996, 127.09750413894653],
                    [37.506525770273, 127.09731101989746],
                    [37.506713012345756, 127.0999503135681],
                    [37.508789665662825, 127.10413455963133],
                    [37.51236409754048, 127.10808277130126],
                    [37.51573411938411, 127.10664510726929],
                    [37.51872956660235, 127.10490703582762],
                    [37.51610855686206, 127.09810495376587],
                    [37.5133853323509, 127.10005760192871],
                    [37.51239813892599, 127.09649562835693],
                    [37.51204070360409, 127.09250450134277],
                    [37.51176837078138, 127.0854878425598],
                    [37.51188751651357, 127.07825660705566],
                ],
                'yeouido' => [
                    [37.52118029761729, 126.94307327270506],
                    [37.522728981960135, 126.94124937057494],
                    [37.52614958840172, 126.93727970123291],
                    [37.53059103733898, 126.9316577911377],
                    [37.53236073641161, 126.92747354507445],
                    [37.5338921728706, 126.92290306091309],
                    [37.53504923733927, 126.91713094711302],
                    [37.5360021004809, 126.9111442565918],
                    [37.53487908192565, 126.90959930419923],
                    [37.52613257084744, 126.91195964813232],
                    [37.52055060358228, 126.91603660583495],
                    [37.51857639324129, 126.91835403442383],
                    [37.515580939874376, 126.92796707153319],
                    [37.517623307485366, 126.94067001342773],
                    [37.518244516547, 126.94292306900024],
                    [37.519495428691314, 126.9442319869995],
                    [37.52118029761729, 126.94307327270506],
                ],
                'yeongdeungpo' => [
                    [37.51302790175676, 126.897132396698],
                    [37.51142795335554, 126.89807653427125],
                    [37.51505331915641, 126.90736770629883],
                    [37.51697656378961, 126.91247463226318],
                    [37.51847427749256, 126.91221714019777],
                    [37.520618678869305, 126.90099477767944],
                    [37.52148663333442, 126.89556598663329],
                    [37.5159213383579, 126.8942356109619],
                    [37.51302790175676, 126.897132396698],
                ],
                'mokdong' => [
                    [37.524277634156626, 126.87595367431639],
                    [37.52563906008423, 126.87696218490599],
                    [37.5268983569474, 126.87007427215575],
                    [37.52536677688631, 126.86975240707396],
                    [37.52596239509099, 126.8662977218628],
                    [37.52693239170272, 126.86655521392822],
                    [37.527000461166764, 126.8647527694702],
                    [37.52808956414415, 126.86520338058473],
                    [37.52815763255225, 126.86423778533937],
                    [37.52991037266865, 126.86410903930663],
                    [37.529331802815086, 126.86061143875123],
                    [37.52817464964456, 126.86084747314452],
                    [37.5278853585471, 126.86194181442262],
                    [37.52652397361402, 126.86134099960327],
                    [37.5257752013105, 126.86155557632446],
                    [37.52618362349867, 126.86453819274902],
                    [37.525230634914664, 126.86975240707396],
                    [37.52346076667454, 126.86925888061522],
                    [37.52266090859851, 126.87470912933348],
                    [37.524277634156626, 126.87595367431639],
                ],
                'guro' => [
                    [37.4848280435154, 126.90293669700623],
                    [37.48733096680062, 126.8975508213043],
                    [37.48453858439259, 126.89534068107605],
                    [37.48380641807607, 126.89717531204224],
                    [37.4836872275315, 126.8985593318939],
                    [37.482605990334, 126.90102696418762],
                    [37.4848280435154, 126.90293669700623],
                ],
                'gwanak' => [
                    [37.47704631107233, 126.96351170539856],
                    [37.48108201527433, 126.95261120796202],
                    [37.47792328642751, 126.95212841033934],
                    [37.4767312785779, 126.95242881774902],
                    [37.476841965821876, 126.95324420928955],
                    [37.47688453779511, 126.95409178733826],
                    [37.476339614705914, 126.95619463920593],
                    [37.476458816971196, 126.95685982704163],
                    [37.478366027357644, 126.95826530456544],
                    [37.476484360289035, 126.96314692497253],
                    [37.47704631107233, 126.96351170539856],
                ],
            ],
        ];

        return $data[$key];
    }
}
